# Red Alert — Дизайн-документ

**Дата:** 2026-02-08
**Статус:** Утверждён
**Платформа:** PWA (Progressive Web App)
**Хостинг:** GitHub Pages
**Язык интерфейса:** Русский

---

## 1. Обзор проекта

Приватное приложение-трекер менструального цикла для одного пользователя. Работает полностью оффлайн, без регистрации, без серверной части, без аналитики. Устанавливается на iPhone через Safari → «На экран Домой».

### Ключевые принципы

- **Приватность:** все данные хранятся исключительно на устройстве (IndexedDB), никуда не отправляются
- **Оффлайн-first:** после первого открытия работает без интернета
- **Простота:** один профиль, один экран, минимум действий

---

## 2. Технический стек

- **Frontend:** Vanilla HTML + CSS + JavaScript (без фреймворков)
- **Хранение данных:** IndexedDB (через обёртку idb или напрямую)
- **Оффлайн:** Service Worker (Cache First)
- **Деплой:** GitHub Pages (бесплатный HTTPS)

### Структура файлов

```
/
├── index.html          # Единственная HTML-страница
├── style.css           # Стили (тёмная тема)
├── app.js              # Логика приложения
├── db.js               # Работа с IndexedDB
├── calc.js             # Алгоритм прогнозирования
├── sw.js               # Service Worker
├── manifest.json       # PWA-манифест
└── icons/
    ├── icon-192.png
    └── icon-512.png
```

---

## 3. Дизайн

### Визуальный стиль

Тёмная тема с яркими градиентами:

- **Фон:** `#0f0f1a` (тёмно-синий/чёрный)
- **Менструация:** розовый градиент `#ff5e87 → #ff3c6f` с тенью
- **Прогноз менструации:** полупрозрачный розовый контур
- **Овуляция:** фиолетовый градиент `#a882ff → #8b5cf6` с тенью
- **Фертильное окно:** полупрозрачный фиолет с контуром
- **Сегодня:** белая рамка `0 0 0 2px #fff`
- **Текст:** белый `#fff` (заголовки), серый `#666` (вторичный)
- **Шрифт:** DM Sans (Google Fonts, кешируется для оффлайна)

### Макет главного экрана (сверху вниз)

1. **Статус-бар (фиксирован сверху, не скроллится)**
   - Название месяца + год (обновляется при скролле)
   - Бейдж «День N»
   - Текущая фаза (Менструация / Фолликулярная / Овуляция / Лютеиновая)
   - Ключевые даты: конец менструации, овуляция, след. цикл
   - Прогресс-бар цикла (градиент розовый → фиолет)

2. **Календарь (вертикальный скролл с snap)**
   - Бесконечный вертикальный скролл месяцев
   - Каждый месяц: заголовок + строка дней недели + сетка дней
   - Лёгкое подтягивание — видно хвост соседнего месяца
   - Быстрый свайп — snap к границе ближайшего полного месяца
   - Виртуализация: в DOM текущий ± 2 месяца, подгрузка при скролле
   - Кнопка «Сегодня» — мгновенный возврат к текущему дню

3. **Статистика (фиксирована внизу, над навбаром)**
   - Длина цикла (среднее)
   - Дни месячных (среднее)
   - Дней до следующего цикла

4. **Навбар (фиксирован внизу)**
   - Календарь (активный) · История · Настройки

---

## 4. Модель данных

### IndexedDB: база `red-alert`, версия 1

**Таблица `cycles`** (object store, keyPath: `id`, autoIncrement: true):

```javascript
{
  id: Number,              // auto-increment
  startDate: String,       // "2026-02-02" — дата начала месячных (обязательно)
  endDate: String | null,  // "2026-02-06" — дата окончания (факт), null если ещё идут
  predictedEndDate: String,// "2026-02-07" — прогноз окончания
  cycleLength: Number,     // длина этого цикла в днях (рассчитывается при начале следующего)
  periodLength: Number,    // длительность месячных в днях
  createdAt: String,       // ISO timestamp
  updatedAt: String        // ISO timestamp
}
```

**Индексы:**
- `startDate` (unique) — для быстрого поиска по дате
- `createdAt` — для сортировки

**Таблица `settings`** (object store, keyPath: `key`):

```javascript
{ key: "defaultCycleLength", value: 28 }
{ key: "defaultPeriodLength", value: 5 }
```

---

## 5. Алгоритм прогнозирования

### Входные данные

- История завершённых циклов (где известны startDate следующего цикла)
- Настройки по умолчанию (для первого использования)

### Расчёт

1. **Средняя длина цикла** = среднее из последних 3–6 завершённых циклов. Если циклов < 3 — используется `defaultCycleLength` (28).
2. **Средняя длительность месячных** = среднее из последних 3–6. Если < 3 — `defaultPeriodLength` (5).
3. **Прогноз конца менструации** = дата начала + средняя длительность.
4. **Овуляция** = дата начала текущего цикла + средняя длина цикла − 14 дней (метод Огино-Кнауса).
5. **Фертильное окно** = овуляция − 5 дней ... овуляция + 1 день (всего ~6 дней).
6. **Следующий цикл** = дата начала текущего цикла + средняя длина цикла.

### Обновление прогнозов

- При отметке начала нового цикла — пересчитывается длина предыдущего цикла, обновляются средние
- При отметке конца месячных — обновляется средняя длительность
- При редактировании дат — пересчёт затронутых циклов и прогнозов

### Фазы цикла

| Фаза | Период |
|------|--------|
| Менструация | день 1 — конец месячных |
| Фолликулярная | конец месячных — начало фертильного окна |
| Овуляция | фертильное окно (±5/+1 от овуляции) |
| Лютеиновая | конец фертильного окна — начало след. цикла |

---

## 6. Взаимодействие

### Тап по дню в календаре

Открывается модальное окно с вариантами:

- **«Начало месячных»** — создаёт новый цикл с этой датой, автоматически рассчитывает прогноз конца. Если предыдущий цикл не закрыт — закрывает его.
- **«Конец месячных»** — фиксирует реальный конец текущих месячных. Доступно только если есть незакрытый цикл.
- **«Убрать отметку»** — удаляет привязку дня (отмена начала или конца). Если убрать начало — удаляется весь цикл.

### Экран «История»

- Список всех циклов в обратном хронологическом порядке
- Каждая строка: дата начала → дата окончания, длина цикла, длительность месячных
- Тап по строке → редактирование дат начала / конца (date picker)
- Удаление цикла (свайп или кнопка)

### Экран «Настройки»

- Дефолтная длина цикла (ползунок 21–35, по умолчанию 28)
- Дефолтная длительность месячных (ползунок 3–7, по умолчанию 5)
- Экспорт данных в JSON
- Импорт данных из JSON
- Сброс всех данных (с подтверждением)

---

## 7. PWA и оффлайн

### Service Worker (sw.js)

- **Стратегия:** Cache First для всех статических ресурсов
- **Кеш:** HTML, CSS, JS, шрифты, иконки
- **Обновление:** при подключении к сети проверяет новую версию (по хешу / версии в sw.js). Если есть — тост «Доступно обновление» с кнопкой «Обновить»

### manifest.json

```json
{
  "name": "Red Alert",
  "short_name": "Red Alert",
  "display": "standalone",
  "start_url": "/",
  "theme_color": "#0f0f1a",
  "background_color": "#0f0f1a",
  "icons": [
    { "src": "icons/icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "icons/icon-512.png", "sizes": "512x512", "type": "image/png" }
  ]
}
```

### Установка

1. Открыть URL в Safari на iPhone
2. Нажать «Поделиться» (квадрат со стрелкой)
3. Выбрать «На экран Домой»
4. Готово — приложение работает как нативное

---

## 8. Деплой

- Репозиторий на GitHub (приватный)
- GitHub Pages из ветки `main`
- HTTPS по умолчанию (обязателен для Service Worker)
- Обновление: `git push` → через ~1 минуту новая версия доступна
- Service Worker подхватывает обновление при следующем открытии с интернетом

---

## 9. Реализация поэтапно

### Этап 1: Минимальный продукт
- [ ] Каркас HTML + CSS (тёмная тема)
- [ ] Вертикальный календарь со snap-скроллом
- [ ] IndexedDB: создание/чтение циклов
- [ ] Тап по дню → модалка «Начало/Конец/Убрать»
- [ ] Базовый прогноз (фиксированные 28/5)
- [ ] Цветовая кодировка дней в календаре

### Этап 2: Прогнозирование
- [ ] Алгоритм среднего по истории
- [ ] Статус-бар с фазой и прогресс-баром
- [ ] Статистика внизу (длина цикла, дни, дней до)
- [ ] Фертильное окно и овуляция на календаре

### Этап 3: Управление данными
- [ ] Экран «История» — список и редактирование циклов
- [ ] Экран «Настройки» — дефолты, экспорт/импорт JSON, сброс
- [ ] Навбар с переключением экранов

### Этап 4: PWA
- [ ] Service Worker с Cache First
- [ ] manifest.json + иконки
- [ ] Тост обновления
- [ ] Тестирование оффлайн-режима
